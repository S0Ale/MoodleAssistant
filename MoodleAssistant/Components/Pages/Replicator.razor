@page "/Replicator"
@using MoodleAssistant.Components.Upload
@using MoodleAssistant.Services
@using MoodleAssistant.Classes.Models
@using MoodleAssistant.Classes.Parse
@using MoodleAssistant.Classes.Utils
@using MoodleAssistant.Components.Sections
@using Microsoft.AspNetCore.Components.Sections
@using ValidationException = MoodleAssistant.Classes.Utils.ReplicatorException
@rendermode InteractiveServer
@inject NavigationManager NavigationManager;
@inject ReplicatorState ReplicatorState;
@inject IBrowserFileService FileService;
@inject IJSRuntime Js;

@{
    var mainForm = "main-upload";
}

<PageTitle>Replicator</PageTitle>
<div id="content" class="pt-8 pb-8">
    <div class="flex items-center justify-center mx-auto">
        <div class="pb-9">
            <p class="mb-6 text-center">Here you can upload your XML and CSV files:</p>
            <form method="post" id="@(mainForm)" @formname="main-upload" @onsubmit="Submit">
                <div class="flex flex-col space-y-3 md:space-y-0 md:space-x-3 md:flex-row">
                    <DropFileInput @ref="_xmlInput" InputName="xml-input"/>
                    <DropFileInput @ref="_csvInput" InputName="csv-input"/>
                </div>
                <div class="flex flex-row mt-3">
                    <button type="submit" class="btn btn-primary py-1.5 px-6" @onclick="() => _isUploading = true">Upload</button>
                    <button type="button" class="btn btn-secondary py-1.5 px-6 ml-3" id="clear-files" @onclick="ClearForm">Clear</button>
                </div>
                <div class="error-container">
                    <Message @ref="_dialog" MsgText="@(ErrorMessage.GetErrorMessage(Error))" Type="MessageType.Error" CanClose="true"/>
                    @if (_isUploading){
                        <Message MsgText="Uploading..." Type="MessageType.Info" CanClose="false" />
                    }
                    @if (_successfulUpload){
                        <Message MsgText="Files uploaded successfully." Type="MessageType.Success" CanClose="true" />
                    }
                </div>
            </form>
        </div>
    </div>
</div>
@if (_successfulUpload){
    <Analysis />
    @if (_showFileParams){
        <FileParam OnSuccess="() => _showDownload = true" />
    }
    @if (!_showFileParams && _showDownload){
        <Preview />
    }

    <div class="flex flex-row justify-center py-6 border-t border-zinc-200">
        @if (_showDownload){
            <button class="btn btn-primary py-1.5 px-5 mr-4" @onclick="Download">Download</button>
        }
        <button class="btn btn-secondary py-1.5 px-5" @onclick="Reset">Reset</button>
    </div>
}
<SectionContent SectionId="App.LocalScripts"> 
    <script src="js/replicator.js"></script>
</SectionContent>

@code{
    public Error Error{ get; private set; } = Error.NoErrors; // public for testing purposes
    
    private Message _dialog = null!;
    private DropFileInput _xmlInput = null!;
    private DropFileInput _csvInput = null!;
    
    private bool _isUploading;
    private bool _successfulUpload;
    private bool _showFileParams;
    private bool _showDownload;
    
    public bool SuccessUpload => _successfulUpload; // testing
    public bool IsUploading => _isUploading; // testing
    
    private async Task Submit(){ 
        Thread.Sleep(250);
        var state = ReplicatorState;
        
        var totalFiles = _xmlInput.UploadedFiles.Count + _csvInput.UploadedFiles.Count;
        if(totalFiles < 2){
            SetError(Error.NoFiles);
            return;
        }
        var loader = new Loader(FileService);
        
        XmlFileModel xmlModel;
        try{ xmlModel = await loader.LoadXml(_xmlInput.UploadedFiles.Values.FirstOrDefault()!); }
        catch (ValidationException e){
            SetError(e.Error);
            return;
        }
        ReplicatorState.XmlModel = xmlModel;
        
        List<string[]> csvList;
        try{ csvList = await loader.LoadCsv(_csvInput.UploadedFiles.Values.FirstOrDefault()!, xmlModel) as List<string[]> ?? []; }
        catch (ValidationException e){
            SetError(e.Error);
            return;
        }
        ReplicatorState.CsvAsList = csvList;
        FileService.DeleteAllFiles();

        state.FileParam = new ParameterModel(xmlModel.XmlFile, csvList.Count() - 1);
        
        if (state.FileParam.GetFileParameters().Count > 0){
            _showFileParams = true;
        }else{
            if (state.XmlModel?.XmlFile == null){
                SetError(Error.Unexpected);
                return;
            }
            var merger = new Merger(state, FileService, state.XmlModel.XmlFile){
                CsvAsList = state.CsvAsList
            };
            merger.MergeQuestion();

            if (state is{ XmlModel: not null, Merged: not null }) state.Preview = new PreviewModel(state.Merged, state.XmlModel.AnswerCount);
            else{
                SetError(Error.Unexpected);
                return;
            }

            _showDownload = true;
        }

        ClearForm();
        _successfulUpload = true;
        _isUploading = false;
    }

    private void ClearForm(){
        _xmlInput.ClearFiles();
        _csvInput.ClearFiles();
    }
    
    private void Reset(){
        FileService.DeleteAllFiles();
        NavigationManager.NavigateTo("/Replicator", true);
    }

    private void SetError(Error err){
        _isUploading = false;
        FileService.DeleteAllFiles();
        Error = err;
        _dialog.Show();
        _dialog.Refresh();
    }
    
    private async Task Download(){
        var stream = new MemoryStream();
        ReplicatorState.Merged?.Save(stream);
        stream.Flush();
        stream.Position = 0;
        using var streamRef = new DotNetStreamReference(stream);
        await Js.InvokeVoidAsync("downloadFileFromStream", "Question.xml", streamRef);
        
        FileService.DeleteAllFiles();
    }
}